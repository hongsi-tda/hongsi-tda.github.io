---
title:  "TIS 200517"
excerpt:  "계층형 질의와 셀프조인, 서브쿼리"

categories:
  - TIS
tags:
  - SQL
  
toc: true
toc_sticky: true
---

## Today I Studied 2020.05.17


### 계층형 질의와 셀프 조인


#### 계층형 질의

계층형 데이터는 상위와 하위 데이터가 포함된 데이터를 의미하고, 이런 데이터를 조회하기 위새 계층형 질의를 사용합니다.


#### Oracle 계층형 질의

```SQL
SELECT ...
  FROM 테이블
  WHERE 조건식 ...
  START WITH 조건식 ...
  --시작 위치 / 루트 데이터 지정
  CONNECT BY [NOCYCLE] 조건식 ... 
  --다음에 전개될 자식 데이터 지정
  --사이클이 발생한 테이블은 다시 전
  PRIOR 테이블1 = 테이블2
  --(방향) 테이블1 -> 테이블2
  [ORDER SIBLINGS BY 컬럼, ... ]
  --형제 노드 사이에서 정렬 지정
```

오라클은 계층형 질의를 사용할때 가상 컬럼(Pseudo Column)을 제공합니다.

가상 컬럼 | 설명
---------|-------
LEVLE | 루트면 1, 하위면 2
CONNCET_BY_ISLEAF | (전개 중) 리프면 1, 아니면 0
CONNECT_BY_ISCYCLE | 조상으로서 존재하면 1, 아니면 0

*들여쓰기 할때 LPAD 함수 사용*

함수 | 설명
-----|-------
SYS_CONNECT_BY_PATH | (컬럼, 경로분리자); 루트부터 현재까지 경로 표시
CONNECT_BY_ROOT | 컬럼; 현재의 루트 표시, 단항 연산자 


#### SQL Server 계층형 질의

```SQL
WITH EMPLOYEES_ANCHOR AS (
  SELECT EMPLOYEEID, LASTNAME, REPORTSTO, 0 AS LEVEL
  FROM EMPLOYEES
  WHERE REPORTSTO IS NULL /*재귀 호출 시작점*/
  --앵커 멤버
 UNION ALL 
  SELECT R.EMPLOYEEID, R.LASTNAME, R.FIRSTNAME, R.REPORTSTO, A.LEVEL + 1
  FROM EMPLOYEES R
  WHERE A.EMPLOYEEID = R.REPORTSTO)
  --재귀 멤버
  SELECT LEVEL, EMPLOYEEID, LASTNAME, FIRSTNAME, REPORTSTO
  FROM EMPLOYEES_ANCHOR GO
  
```

앵커 멤버가 Outer 집합이 되어 Inner 집합인 재귀 멤버와 조인을 시작하고,<br>
더 조인할 수 없으면 결과 집합을 모두 합하여 리턴 합니다. 

`AS SORT` 와 마지막 부분에 `ORDER BY SORT GO`(가상 컬럼) 를 지정해줘야만 실제 조직도와 같게 출력이 가능하다는 한계가 있습니다. 


#### 셀프 조인

동일 테이블 사이 조인으로, 테이블명과 컬럼명이 같기 때문에 반드시 ALIAS 를 지정해야 합니다.

```SQL
SELECT A.컬럼명, B.컬럼명, ...
  FROM 테이블1 A, 테이블2 B 
  WHERE A.컬럼명2 = B.컬럼명1;
```

동일하지만 개념적으로는 서로 다른 두개의 테이블을 조인하는 것과 같습니다. 


### 서브쿼리

정의


#### 단일 행 서브쿼리


#### 다중 행 서브쿼리


#### 다중 컬럼 서브쿼리


#### 연관 서브쿼리


#### 그 외에...

* SELECT 절에 서브쿼리 

* FROM 절에 서브쿼리

* HAVING 절에 서브쿼리

* UPDATE SET 절에 서브쿼리

* INSERT VALUE 절에 서브쿼리


#### View
