---
title:  "TIS 200505"
excerpt:  "RFM part1"

categories:
  - TIS
tags:
  - Python
  - 실무
  - 머신러닝
  
toc: true
toc_sticky: true
---

## Today I Studied 2020.05.05

### RFM part1
> RFM이란?<br>

최근성(Recency), 구매빈도(Frequency), 구매액(Monetary) 지표를 통해<br>
얼마나 최근에, 얼마나 자주, 얼마나 높은 액수로 구매했는가에 대한 정보를 기반으로<br> 
고객의 수익기여도를 나타내는 지표 

### RFM 기본모형
`RFM = Recency + Frequency + Monetary`

단순하고 계량화해 순위 매기기 가능해 고객 세분화를 통한 마케팅 전략에 많이 활용됨


```python
import pandas as pd
import datetime as dt
```


```python
rd = pd.read_csv('./data/Online Retail_2.csv')
rd.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>2010-12-01</td>
      <td>2.55</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1</th>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>2010-12-01</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>2</th>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>2010-12-01</td>
      <td>2.75</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>3</th>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>2010-12-01</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>4</th>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>2010-12-01</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
  </tbody>
</table>
</div>



### 데이터 전처리

#### 필요한 컬럼 선택


```python
rd1 = rd[['CustomerID', 'InvoiceDate', 'Quantity', 'UnitPrice']].copy()
rd1.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CustomerID</th>
      <th>InvoiceDate</th>
      <th>Quantity</th>
      <th>UnitPrice</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>6</td>
      <td>2.55</td>
    </tr>
    <tr>
      <th>1</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>6</td>
      <td>3.39</td>
    </tr>
    <tr>
      <th>2</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>8</td>
      <td>2.75</td>
    </tr>
    <tr>
      <th>3</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>6</td>
      <td>3.39</td>
    </tr>
    <tr>
      <th>4</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>6</td>
      <td>3.39</td>
    </tr>
  </tbody>
</table>
</div>



#### 데이트타임으로 형변환


```python
rd1['Date'] = pd.to_datetime(rd1['InvoiceDate'])
```


```python
rd1.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 541909 entries, 0 to 541908
    Data columns (total 5 columns):
     #   Column       Non-Null Count   Dtype         
    ---  ------       --------------   -----         
     0   CustomerID   406829 non-null  float64       
     1   InvoiceDate  541909 non-null  object        
     2   Quantity     541909 non-null  int64         
     3   UnitPrice    541909 non-null  float64       
     4   Date         541909 non-null  datetime64[ns]
    dtypes: datetime64[ns](1), float64(2), int64(1), object(1)
    memory usage: 20.7+ MB
    

#### 결측치 제거


```python
print(rd1.isna().sum())
rd1 = rd1.dropna()
rd1.isna().sum()
```

    CustomerID     135080
    InvoiceDate         0
    Quantity            0
    UnitPrice           0
    Date                0
    dtype: int64
    




    CustomerID     0
    InvoiceDate    0
    Quantity       0
    UnitPrice      0
    Date           0
    dtype: int64




```python
rd1.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CustomerID</th>
      <th>InvoiceDate</th>
      <th>Quantity</th>
      <th>UnitPrice</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>6</td>
      <td>2.55</td>
      <td>2010-12-01</td>
    </tr>
    <tr>
      <th>1</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>6</td>
      <td>3.39</td>
      <td>2010-12-01</td>
    </tr>
    <tr>
      <th>2</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>8</td>
      <td>2.75</td>
      <td>2010-12-01</td>
    </tr>
    <tr>
      <th>3</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>6</td>
      <td>3.39</td>
      <td>2010-12-01</td>
    </tr>
    <tr>
      <th>4</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>6</td>
      <td>3.39</td>
      <td>2010-12-01</td>
    </tr>
  </tbody>
</table>
</div>



#### 고객ID별, 구매날짜별 구매액 구하기


```python
group = rd1.groupby(['CustomerID', 'Date'])['UnitPrice'].sum().reset_index()
```


```python
group.columns = ['ID', 'Date', 'Paying']
```


```python
group
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Date</th>
      <th>Paying</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346.0</td>
      <td>2011-01-18</td>
      <td>2.08</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12347.0</td>
      <td>2010-12-07</td>
      <td>89.59</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12347.0</td>
      <td>2011-01-26</td>
      <td>73.17</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12347.0</td>
      <td>2011-04-07</td>
      <td>62.29</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12347.0</td>
      <td>2011-06-09</td>
      <td>53.62</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>19291</th>
      <td>18283.0</td>
      <td>2011-11-30</td>
      <td>85.08</td>
    </tr>
    <tr>
      <th>19292</th>
      <td>18283.0</td>
      <td>2011-12-06</td>
      <td>65.38</td>
    </tr>
    <tr>
      <th>19293</th>
      <td>18287.0</td>
      <td>2011-05-22</td>
      <td>56.92</td>
    </tr>
    <tr>
      <th>19294</th>
      <td>18287.0</td>
      <td>2011-10-12</td>
      <td>45.70</td>
    </tr>
    <tr>
      <th>19295</th>
      <td>18287.0</td>
      <td>2011-10-28</td>
      <td>1.93</td>
    </tr>
  </tbody>
</table>
<p>19296 rows × 3 columns</p>
</div>



#### 2011년도 데이터만 가져오기


```python
g2011 = group[(group['Date'] >='2011-01-01')&(group['Date'] <='2011-12-31')]
g2011
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Date</th>
      <th>Paying</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346.0</td>
      <td>2011-01-18</td>
      <td>2.08</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12347.0</td>
      <td>2011-01-26</td>
      <td>73.17</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12347.0</td>
      <td>2011-04-07</td>
      <td>62.29</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12347.0</td>
      <td>2011-06-09</td>
      <td>53.62</td>
    </tr>
    <tr>
      <th>5</th>
      <td>12347.0</td>
      <td>2011-08-02</td>
      <td>68.24</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>19291</th>
      <td>18283.0</td>
      <td>2011-11-30</td>
      <td>85.08</td>
    </tr>
    <tr>
      <th>19292</th>
      <td>18283.0</td>
      <td>2011-12-06</td>
      <td>65.38</td>
    </tr>
    <tr>
      <th>19293</th>
      <td>18287.0</td>
      <td>2011-05-22</td>
      <td>56.92</td>
    </tr>
    <tr>
      <th>19294</th>
      <td>18287.0</td>
      <td>2011-10-12</td>
      <td>45.70</td>
    </tr>
    <tr>
      <th>19295</th>
      <td>18287.0</td>
      <td>2011-10-28</td>
      <td>1.93</td>
    </tr>
  </tbody>
</table>
<p>17893 rows × 3 columns</p>
</div>



#### RFM 구하기


```python
rfm = g2011.groupby('ID').agg({'Date' : 'max', 'ID' : 'size', 'Paying' : 'sum'} )
```


```python
rfm.columns = ['Max_Date', 'Frequency', 'Monetary']
```


```python
rfm = rfm.reset_index()
rfm.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346.0</td>
      <td>2011-01-18</td>
      <td>1</td>
      <td>2.08</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12347.0</td>
      <td>2011-12-07</td>
      <td>6</td>
      <td>391.62</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12348.0</td>
      <td>2011-09-25</td>
      <td>3</td>
      <td>129.11</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12349.0</td>
      <td>2011-11-21</td>
      <td>1</td>
      <td>605.10</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12350.0</td>
      <td>2011-02-02</td>
      <td>1</td>
      <td>65.30</td>
    </tr>
  </tbody>
</table>
</div>



#### 최근 날짜를 기준으로 최근성 정의하기


```python
rfm['Recency'] = rfm['Max_Date'] - pd.to_datetime('2011-01-01')
rfm.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346.0</td>
      <td>2011-01-18</td>
      <td>1</td>
      <td>2.08</td>
      <td>17 days</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12347.0</td>
      <td>2011-12-07</td>
      <td>6</td>
      <td>391.62</td>
      <td>340 days</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12348.0</td>
      <td>2011-09-25</td>
      <td>3</td>
      <td>129.11</td>
      <td>267 days</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12349.0</td>
      <td>2011-11-21</td>
      <td>1</td>
      <td>605.10</td>
      <td>324 days</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12350.0</td>
      <td>2011-02-02</td>
      <td>1</td>
      <td>65.30</td>
      <td>32 days</td>
    </tr>
  </tbody>
</table>
</div>




```python
rfm.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 4244 entries, 0 to 4243
    Data columns (total 5 columns):
     #   Column     Non-Null Count  Dtype          
    ---  ------     --------------  -----          
     0   ID         4244 non-null   float64        
     1   Max_Date   4244 non-null   datetime64[ns] 
     2   Frequency  4244 non-null   int64          
     3   Monetary   4244 non-null   float64        
     4   Recency    4244 non-null   timedelta64[ns]
    dtypes: datetime64[ns](1), float64(2), int64(1), timedelta64[ns](1)
    memory usage: 165.9 KB
    

### RFM 정의하기

#### 구매 달 구하기


```python
# rfm['Month'] = rfm['Max_Date'].dt.month
rfm['Month'] = rfm['Max_Date'].map(lambda x : x.strftime('%Y-%m'))
rfm.head(1)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346.0</td>
      <td>2011-01-18</td>
      <td>1</td>
      <td>2.08</td>
      <td>17 days</td>
      <td>2011-01</td>
    </tr>
  </tbody>
</table>
</div>



#### Frequency 를 01, 02, ... 로 


```python
rfm['Freq_2'] = rfm['Frequency'].copy()
```


```python
# for x in range(1, 4):
#     print('[{0:02d}] [{1:03d}] [{2:04d}]'.format(x, x*x, x*x*x))
rfm['Freq_2'] = rfm.loc[rfm['Freq_2'] <= 10, 'Freq_2'].apply('{0:02d}'.format)
rfm.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346.0</td>
      <td>2011-01-18</td>
      <td>1</td>
      <td>2.08</td>
      <td>17 days</td>
      <td>2011-01</td>
      <td>01</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12347.0</td>
      <td>2011-12-07</td>
      <td>6</td>
      <td>391.62</td>
      <td>340 days</td>
      <td>2011-12</td>
      <td>06</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12348.0</td>
      <td>2011-09-25</td>
      <td>3</td>
      <td>129.11</td>
      <td>267 days</td>
      <td>2011-09</td>
      <td>03</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12349.0</td>
      <td>2011-11-21</td>
      <td>1</td>
      <td>605.10</td>
      <td>324 days</td>
      <td>2011-11</td>
      <td>01</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12350.0</td>
      <td>2011-02-02</td>
      <td>1</td>
      <td>65.30</td>
      <td>32 days</td>
      <td>2011-02</td>
      <td>01</td>
    </tr>
  </tbody>
</table>
</div>




```python
rfm.loc[rfm['Frequency'] > 10, 'Freq_2'] = '10~'
```


```python
rfm.tail()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4239</th>
      <td>18280.0</td>
      <td>2011-03-07</td>
      <td>1</td>
      <td>47.65</td>
      <td>65 days</td>
      <td>2011-03</td>
      <td>01</td>
    </tr>
    <tr>
      <th>4240</th>
      <td>18281.0</td>
      <td>2011-06-12</td>
      <td>1</td>
      <td>39.36</td>
      <td>162 days</td>
      <td>2011-06</td>
      <td>01</td>
    </tr>
    <tr>
      <th>4241</th>
      <td>18282.0</td>
      <td>2011-12-02</td>
      <td>3</td>
      <td>62.68</td>
      <td>335 days</td>
      <td>2011-12</td>
      <td>03</td>
    </tr>
    <tr>
      <th>4242</th>
      <td>18283.0</td>
      <td>2011-12-06</td>
      <td>14</td>
      <td>1220.93</td>
      <td>339 days</td>
      <td>2011-12</td>
      <td>10~</td>
    </tr>
    <tr>
      <th>4243</th>
      <td>18287.0</td>
      <td>2011-10-28</td>
      <td>3</td>
      <td>104.55</td>
      <td>300 days</td>
      <td>2011-10</td>
      <td>03</td>
    </tr>
  </tbody>
</table>
</div>



#### 월별 구매 빈도 테이블 만들기


```python
tdata = rfm.pivot_table(index='Month', columns='Freq_2', values='Frequency', aggfunc='count')
```


```python
tdata = tdata.fillna(0).copy()
```


```python
tdata.reset_index().rename(columns={'Month' : 'gbn'})
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Freq_2</th>
      <th>gbn</th>
      <th>01</th>
      <th>02</th>
      <th>03</th>
      <th>04</th>
      <th>05</th>
      <th>06</th>
      <th>07</th>
      <th>08</th>
      <th>09</th>
      <th>10</th>
      <th>10~</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2011-01</td>
      <td>81.0</td>
      <td>16.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2011-02</td>
      <td>87.0</td>
      <td>13.0</td>
      <td>5.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2011-03</td>
      <td>132.0</td>
      <td>26.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2011-04</td>
      <td>89.0</td>
      <td>37.0</td>
      <td>10.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2011-05</td>
      <td>89.0</td>
      <td>36.0</td>
      <td>24.0</td>
      <td>7.0</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2011-06</td>
      <td>83.0</td>
      <td>55.0</td>
      <td>23.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>4.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2011-07</td>
      <td>85.0</td>
      <td>48.0</td>
      <td>27.0</td>
      <td>14.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2011-08</td>
      <td>74.0</td>
      <td>57.0</td>
      <td>29.0</td>
      <td>26.0</td>
      <td>14.0</td>
      <td>7.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2011-09</td>
      <td>140.0</td>
      <td>92.0</td>
      <td>59.0</td>
      <td>44.0</td>
      <td>24.0</td>
      <td>19.0</td>
      <td>6.0</td>
      <td>5.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2011-10</td>
      <td>227.0</td>
      <td>133.0</td>
      <td>88.0</td>
      <td>66.0</td>
      <td>48.0</td>
      <td>23.0</td>
      <td>19.0</td>
      <td>14.0</td>
      <td>12.0</td>
      <td>6.0</td>
      <td>11.0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2011-11</td>
      <td>261.0</td>
      <td>220.0</td>
      <td>160.0</td>
      <td>148.0</td>
      <td>108.0</td>
      <td>95.0</td>
      <td>63.0</td>
      <td>36.0</td>
      <td>39.0</td>
      <td>28.0</td>
      <td>110.0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2011-12</td>
      <td>46.0</td>
      <td>90.0</td>
      <td>60.0</td>
      <td>57.0</td>
      <td>70.0</td>
      <td>41.0</td>
      <td>40.0</td>
      <td>37.0</td>
      <td>28.0</td>
      <td>26.0</td>
      <td>191.0</td>
    </tr>
  </tbody>
</table>
</div>



#### 고객 세분화
<img src="./data/rfm-segments.png" align="left"/>

#### 이탈고객


```python
rfm.head(1)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346.0</td>
      <td>2011-01-18</td>
      <td>1</td>
      <td>2.08</td>
      <td>17 days</td>
      <td>2011-01</td>
      <td>01</td>
    </tr>
  </tbody>
</table>
</div>




```python
tdata.head(1)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Freq_2</th>
      <th>01</th>
      <th>02</th>
      <th>03</th>
      <th>04</th>
      <th>05</th>
      <th>06</th>
      <th>07</th>
      <th>08</th>
      <th>09</th>
      <th>10</th>
      <th>10~</th>
    </tr>
    <tr>
      <th>Month</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2011-01</th>
      <td>81.0</td>
      <td>16.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
rfm.loc[(rfm['Max_Date'] >= '2011-01-01') 
                & (rfm['Max_Date'] <= '2011-03-31') 
                & (rfm['Frequency'] >= 1) & (rfm['Frequency'] <= 3), 'gbn'] = '이탈고객'
```


```python
rfm.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
      <th>gbn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346.0</td>
      <td>2011-01-18</td>
      <td>1</td>
      <td>2.08</td>
      <td>17 days</td>
      <td>2011-01</td>
      <td>01</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12347.0</td>
      <td>2011-12-07</td>
      <td>6</td>
      <td>391.62</td>
      <td>340 days</td>
      <td>2011-12</td>
      <td>06</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12348.0</td>
      <td>2011-09-25</td>
      <td>3</td>
      <td>129.11</td>
      <td>267 days</td>
      <td>2011-09</td>
      <td>03</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12349.0</td>
      <td>2011-11-21</td>
      <td>1</td>
      <td>605.10</td>
      <td>324 days</td>
      <td>2011-11</td>
      <td>01</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12350.0</td>
      <td>2011-02-02</td>
      <td>1</td>
      <td>65.30</td>
      <td>32 days</td>
      <td>2011-02</td>
      <td>01</td>
      <td>이탈고객</td>
    </tr>
  </tbody>
</table>
</div>



### RFM 함수 구현하기

#### 함수 구현 전 검토


```python
rec_start = '2011-01-01'
rec_end = '2011-03-31'
fre_start = 1
fre_end = 3
naming = '이탈고객'
```


```python
nrfm = rfm[(rfm['Max_Date'] >= rec_start) & (rfm['Max_Date'] <= rec_end) 
                    & (rfm['Frequency'] >= fre_start) & (rfm['Frequency'] <= fre_end)].copy()
nrfm['naming'] = '이탈고객'
```


```python
nrfm
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
      <th>gbn</th>
      <th>naming</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346.0</td>
      <td>2011-01-18</td>
      <td>1</td>
      <td>2.08</td>
      <td>17 days</td>
      <td>2011-01</td>
      <td>01</td>
      <td>이탈고객</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12350.0</td>
      <td>2011-02-02</td>
      <td>1</td>
      <td>65.30</td>
      <td>32 days</td>
      <td>2011-02</td>
      <td>01</td>
      <td>이탈고객</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>14</th>
      <td>12361.0</td>
      <td>2011-02-25</td>
      <td>1</td>
      <td>33.35</td>
      <td>55 days</td>
      <td>2011-02</td>
      <td>01</td>
      <td>이탈고객</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>18</th>
      <td>12365.0</td>
      <td>2011-02-21</td>
      <td>1</td>
      <td>698.00</td>
      <td>51 days</td>
      <td>2011-02</td>
      <td>01</td>
      <td>이탈고객</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>23</th>
      <td>12373.0</td>
      <td>2011-02-01</td>
      <td>1</td>
      <td>64.15</td>
      <td>31 days</td>
      <td>2011-02</td>
      <td>01</td>
      <td>이탈고객</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4188</th>
      <td>18212.0</td>
      <td>2011-01-17</td>
      <td>1</td>
      <td>131.48</td>
      <td>16 days</td>
      <td>2011-01</td>
      <td>01</td>
      <td>이탈고객</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>4199</th>
      <td>18224.0</td>
      <td>2011-03-21</td>
      <td>1</td>
      <td>30.60</td>
      <td>79 days</td>
      <td>2011-03</td>
      <td>01</td>
      <td>이탈고객</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>4208</th>
      <td>18233.0</td>
      <td>2011-01-18</td>
      <td>1</td>
      <td>110.00</td>
      <td>17 days</td>
      <td>2011-01</td>
      <td>01</td>
      <td>이탈고객</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>4220</th>
      <td>18250.0</td>
      <td>2011-02-11</td>
      <td>2</td>
      <td>86.27</td>
      <td>41 days</td>
      <td>2011-02</td>
      <td>02</td>
      <td>이탈고객</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>4239</th>
      <td>18280.0</td>
      <td>2011-03-07</td>
      <td>1</td>
      <td>47.65</td>
      <td>65 days</td>
      <td>2011-03</td>
      <td>01</td>
      <td>이탈고객</td>
      <td>이탈고객</td>
    </tr>
  </tbody>
</table>
<p>364 rows × 9 columns</p>
</div>



#### 함수 구현하기


```python
def rfm_fun(df, rec_start, rec_end, fre_start, fre_end, naming):
    ndf = df[(df['Max_Date'] >= rec_start) & (df['Max_Date'] <= rec_end) 
                        & (df['Frequency'] >= fre_start) & (df['Frequency'] <= fre_end)].copy()
    ndf['gbn'] = naming
    return ndf
```


```python
rfm0 = rfm_fun(rfm, '2011-01-01', '2011-03-31', 1, 3, '이탈고객')
rfm0
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
      <th>gbn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346.0</td>
      <td>2011-01-18</td>
      <td>1</td>
      <td>2.08</td>
      <td>17 days</td>
      <td>2011-01</td>
      <td>01</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12350.0</td>
      <td>2011-02-02</td>
      <td>1</td>
      <td>65.30</td>
      <td>32 days</td>
      <td>2011-02</td>
      <td>01</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>14</th>
      <td>12361.0</td>
      <td>2011-02-25</td>
      <td>1</td>
      <td>33.35</td>
      <td>55 days</td>
      <td>2011-02</td>
      <td>01</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>18</th>
      <td>12365.0</td>
      <td>2011-02-21</td>
      <td>1</td>
      <td>698.00</td>
      <td>51 days</td>
      <td>2011-02</td>
      <td>01</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>23</th>
      <td>12373.0</td>
      <td>2011-02-01</td>
      <td>1</td>
      <td>64.15</td>
      <td>31 days</td>
      <td>2011-02</td>
      <td>01</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4188</th>
      <td>18212.0</td>
      <td>2011-01-17</td>
      <td>1</td>
      <td>131.48</td>
      <td>16 days</td>
      <td>2011-01</td>
      <td>01</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>4199</th>
      <td>18224.0</td>
      <td>2011-03-21</td>
      <td>1</td>
      <td>30.60</td>
      <td>79 days</td>
      <td>2011-03</td>
      <td>01</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>4208</th>
      <td>18233.0</td>
      <td>2011-01-18</td>
      <td>1</td>
      <td>110.00</td>
      <td>17 days</td>
      <td>2011-01</td>
      <td>01</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>4220</th>
      <td>18250.0</td>
      <td>2011-02-11</td>
      <td>2</td>
      <td>86.27</td>
      <td>41 days</td>
      <td>2011-02</td>
      <td>02</td>
      <td>이탈고객</td>
    </tr>
    <tr>
      <th>4239</th>
      <td>18280.0</td>
      <td>2011-03-07</td>
      <td>1</td>
      <td>47.65</td>
      <td>65 days</td>
      <td>2011-03</td>
      <td>01</td>
      <td>이탈고객</td>
    </tr>
  </tbody>
</table>
<p>364 rows × 8 columns</p>
</div>




```python
rfm1 = rfm_fun(rfm, '2011-09-01', '2011-12-31', 1, 1, '신규고객')
rfm1
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
      <th>gbn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3</th>
      <td>12349.0</td>
      <td>2011-11-21</td>
      <td>1</td>
      <td>605.10</td>
      <td>324 days</td>
      <td>2011-11</td>
      <td>01</td>
      <td>신규고객</td>
    </tr>
    <tr>
      <th>10</th>
      <td>12357.0</td>
      <td>2011-11-06</td>
      <td>1</td>
      <td>438.67</td>
      <td>309 days</td>
      <td>2011-11</td>
      <td>01</td>
      <td>신규고객</td>
    </tr>
    <tr>
      <th>19</th>
      <td>12367.0</td>
      <td>2011-12-05</td>
      <td>1</td>
      <td>35.20</td>
      <td>338 days</td>
      <td>2011-12</td>
      <td>01</td>
      <td>신규고객</td>
    </tr>
    <tr>
      <th>24</th>
      <td>12374.0</td>
      <td>2011-11-14</td>
      <td>1</td>
      <td>139.25</td>
      <td>317 days</td>
      <td>2011-11</td>
      <td>01</td>
      <td>신규고객</td>
    </tr>
    <tr>
      <th>35</th>
      <td>12390.0</td>
      <td>2011-09-21</td>
      <td>1</td>
      <td>127.90</td>
      <td>263 days</td>
      <td>2011-09</td>
      <td>01</td>
      <td>신규고객</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4213</th>
      <td>18240.0</td>
      <td>2011-10-24</td>
      <td>1</td>
      <td>23.57</td>
      <td>296 days</td>
      <td>2011-10</td>
      <td>01</td>
      <td>신규고객</td>
    </tr>
    <tr>
      <th>4219</th>
      <td>18249.0</td>
      <td>2011-11-22</td>
      <td>1</td>
      <td>12.83</td>
      <td>325 days</td>
      <td>2011-11</td>
      <td>01</td>
      <td>신규고객</td>
    </tr>
    <tr>
      <th>4221</th>
      <td>18251.0</td>
      <td>2011-09-13</td>
      <td>1</td>
      <td>12.35</td>
      <td>255 days</td>
      <td>2011-09</td>
      <td>01</td>
      <td>신규고객</td>
    </tr>
    <tr>
      <th>4223</th>
      <td>18255.0</td>
      <td>2011-09-11</td>
      <td>1</td>
      <td>10.30</td>
      <td>253 days</td>
      <td>2011-09</td>
      <td>01</td>
      <td>신규고객</td>
    </tr>
    <tr>
      <th>4238</th>
      <td>18278.0</td>
      <td>2011-09-27</td>
      <td>1</td>
      <td>29.55</td>
      <td>269 days</td>
      <td>2011-09</td>
      <td>01</td>
      <td>신규고객</td>
    </tr>
  </tbody>
</table>
<p>674 rows × 8 columns</p>
</div>




```python
rfm2 = rfm_fun(rfm, '2011-01-01', '2011-08-31', 4, 6, '휴면고객')
rfm2
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
      <th>gbn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>31</th>
      <td>12383.0</td>
      <td>2011-06-08</td>
      <td>5</td>
      <td>260.33</td>
      <td>158 days</td>
      <td>2011-06</td>
      <td>05</td>
      <td>휴면고객</td>
    </tr>
    <tr>
      <th>42</th>
      <td>12399.0</td>
      <td>2011-08-12</td>
      <td>4</td>
      <td>124.76</td>
      <td>223 days</td>
      <td>2011-08</td>
      <td>04</td>
      <td>휴면고객</td>
    </tr>
    <tr>
      <th>205</th>
      <td>12601.0</td>
      <td>2011-06-03</td>
      <td>6</td>
      <td>189.81</td>
      <td>153 days</td>
      <td>2011-06</td>
      <td>06</td>
      <td>휴면고객</td>
    </tr>
    <tr>
      <th>240</th>
      <td>12643.0</td>
      <td>2011-08-03</td>
      <td>5</td>
      <td>124.51</td>
      <td>214 days</td>
      <td>2011-08</td>
      <td>05</td>
      <td>휴면고객</td>
    </tr>
    <tr>
      <th>280</th>
      <td>12693.0</td>
      <td>2011-08-11</td>
      <td>6</td>
      <td>225.87</td>
      <td>222 days</td>
      <td>2011-08</td>
      <td>06</td>
      <td>휴면고객</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4168</th>
      <td>18183.0</td>
      <td>2011-05-05</td>
      <td>6</td>
      <td>155.31</td>
      <td>124 days</td>
      <td>2011-05</td>
      <td>06</td>
      <td>휴면고객</td>
    </tr>
    <tr>
      <th>4193</th>
      <td>18218.0</td>
      <td>2011-05-17</td>
      <td>4</td>
      <td>43.97</td>
      <td>136 days</td>
      <td>2011-05</td>
      <td>04</td>
      <td>휴면고객</td>
    </tr>
    <tr>
      <th>4206</th>
      <td>18231.0</td>
      <td>2011-05-31</td>
      <td>6</td>
      <td>470.27</td>
      <td>150 days</td>
      <td>2011-05</td>
      <td>06</td>
      <td>휴면고객</td>
    </tr>
    <tr>
      <th>4212</th>
      <td>18239.0</td>
      <td>2011-05-05</td>
      <td>4</td>
      <td>155.83</td>
      <td>124 days</td>
      <td>2011-05</td>
      <td>04</td>
      <td>휴면고객</td>
    </tr>
    <tr>
      <th>4218</th>
      <td>18248.0</td>
      <td>2011-08-18</td>
      <td>4</td>
      <td>197.17</td>
      <td>229 days</td>
      <td>2011-08</td>
      <td>04</td>
      <td>휴면고객</td>
    </tr>
  </tbody>
</table>
<p>100 rows × 8 columns</p>
</div>




```python
rfm3 = rfm_fun(rfm, '2011-01-01', '2011-08-31', 7, 100000, '고정등급다운')
rfm3
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
      <th>gbn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>457</th>
      <td>12947.0</td>
      <td>2011-07-19</td>
      <td>9</td>
      <td>368.74</td>
      <td>199 days</td>
      <td>2011-07</td>
      <td>09</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>478</th>
      <td>12980.0</td>
      <td>2011-07-07</td>
      <td>10</td>
      <td>348.39</td>
      <td>187 days</td>
      <td>2011-07</td>
      <td>10</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>549</th>
      <td>13082.0</td>
      <td>2011-08-05</td>
      <td>8</td>
      <td>220.02</td>
      <td>216 days</td>
      <td>2011-08</td>
      <td>08</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>556</th>
      <td>13093.0</td>
      <td>2011-03-17</td>
      <td>8</td>
      <td>386.46</td>
      <td>75 days</td>
      <td>2011-03</td>
      <td>08</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>1458</th>
      <td>14364.0</td>
      <td>2011-08-23</td>
      <td>7</td>
      <td>208.80</td>
      <td>234 days</td>
      <td>2011-08</td>
      <td>07</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>1483</th>
      <td>14407.0</td>
      <td>2011-08-24</td>
      <td>9</td>
      <td>305.89</td>
      <td>235 days</td>
      <td>2011-08</td>
      <td>09</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>1532</th>
      <td>14472.0</td>
      <td>2011-08-28</td>
      <td>7</td>
      <td>623.01</td>
      <td>239 days</td>
      <td>2011-08</td>
      <td>07</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>1614</th>
      <td>14573.0</td>
      <td>2011-06-13</td>
      <td>7</td>
      <td>786.79</td>
      <td>163 days</td>
      <td>2011-06</td>
      <td>07</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>2082</th>
      <td>15235.0</td>
      <td>2011-05-06</td>
      <td>7</td>
      <td>316.02</td>
      <td>125 days</td>
      <td>2011-05</td>
      <td>07</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>2185</th>
      <td>15379.0</td>
      <td>2011-06-23</td>
      <td>7</td>
      <td>333.83</td>
      <td>173 days</td>
      <td>2011-06</td>
      <td>07</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>2333</th>
      <td>15581.0</td>
      <td>2011-08-11</td>
      <td>9</td>
      <td>3496.92</td>
      <td>222 days</td>
      <td>2011-08</td>
      <td>09</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>2343</th>
      <td>15596.0</td>
      <td>2011-08-31</td>
      <td>8</td>
      <td>272.52</td>
      <td>242 days</td>
      <td>2011-08</td>
      <td>08</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>2367</th>
      <td>15625.0</td>
      <td>2011-08-31</td>
      <td>7</td>
      <td>109.51</td>
      <td>242 days</td>
      <td>2011-08</td>
      <td>07</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>2765</th>
      <td>16180.0</td>
      <td>2011-08-31</td>
      <td>9</td>
      <td>430.65</td>
      <td>242 days</td>
      <td>2011-08</td>
      <td>09</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>3288</th>
      <td>16919.0</td>
      <td>2011-07-06</td>
      <td>9</td>
      <td>707.56</td>
      <td>186 days</td>
      <td>2011-07</td>
      <td>09</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>3693</th>
      <td>17504.0</td>
      <td>2011-05-17</td>
      <td>7</td>
      <td>486.25</td>
      <td>136 days</td>
      <td>2011-05</td>
      <td>07</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>4090</th>
      <td>18073.0</td>
      <td>2011-08-17</td>
      <td>10</td>
      <td>285.61</td>
      <td>228 days</td>
      <td>2011-08</td>
      <td>10</td>
      <td>고정등급다운</td>
    </tr>
    <tr>
      <th>4226</th>
      <td>18260.0</td>
      <td>2011-06-20</td>
      <td>7</td>
      <td>454.64</td>
      <td>170 days</td>
      <td>2011-06</td>
      <td>07</td>
      <td>고정등급다운</td>
    </tr>
  </tbody>
</table>
</div>




```python
rfm4 = rfm_fun(rfm, '2011-09-01', '2011-12-31', 4, 5, '잠재고정고객')
rfm4
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
      <th>gbn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>17</th>
      <td>12364.0</td>
      <td>2011-12-02</td>
      <td>4</td>
      <td>162.37</td>
      <td>335 days</td>
      <td>2011-12</td>
      <td>04</td>
      <td>잠재고정고객</td>
    </tr>
    <tr>
      <th>29</th>
      <td>12380.0</td>
      <td>2011-11-18</td>
      <td>5</td>
      <td>355.63</td>
      <td>321 days</td>
      <td>2011-11</td>
      <td>05</td>
      <td>잠재고정고객</td>
    </tr>
    <tr>
      <th>37</th>
      <td>12393.0</td>
      <td>2011-09-28</td>
      <td>4</td>
      <td>145.90</td>
      <td>270 days</td>
      <td>2011-09</td>
      <td>04</td>
      <td>잠재고정고객</td>
    </tr>
    <tr>
      <th>48</th>
      <td>12407.0</td>
      <td>2011-10-21</td>
      <td>5</td>
      <td>251.59</td>
      <td>293 days</td>
      <td>2011-10</td>
      <td>05</td>
      <td>잠재고정고객</td>
    </tr>
    <tr>
      <th>50</th>
      <td>12409.0</td>
      <td>2011-09-22</td>
      <td>4</td>
      <td>402.04</td>
      <td>264 days</td>
      <td>2011-09</td>
      <td>04</td>
      <td>잠재고정고객</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4187</th>
      <td>18211.0</td>
      <td>2011-11-14</td>
      <td>5</td>
      <td>102.98</td>
      <td>317 days</td>
      <td>2011-11</td>
      <td>05</td>
      <td>잠재고정고객</td>
    </tr>
    <tr>
      <th>4207</th>
      <td>18232.0</td>
      <td>2011-09-19</td>
      <td>5</td>
      <td>148.32</td>
      <td>261 days</td>
      <td>2011-09</td>
      <td>05</td>
      <td>잠재고정고객</td>
    </tr>
    <tr>
      <th>4211</th>
      <td>18237.0</td>
      <td>2011-12-07</td>
      <td>5</td>
      <td>180.42</td>
      <td>340 days</td>
      <td>2011-12</td>
      <td>05</td>
      <td>잠재고정고객</td>
    </tr>
    <tr>
      <th>4216</th>
      <td>18245.0</td>
      <td>2011-12-02</td>
      <td>5</td>
      <td>423.90</td>
      <td>335 days</td>
      <td>2011-12</td>
      <td>05</td>
      <td>잠재고정고객</td>
    </tr>
    <tr>
      <th>4229</th>
      <td>18263.0</td>
      <td>2011-11-16</td>
      <td>4</td>
      <td>60.61</td>
      <td>319 days</td>
      <td>2011-11</td>
      <td>04</td>
      <td>잠재고정고객</td>
    </tr>
  </tbody>
</table>
<p>565 rows × 8 columns</p>
</div>




```python
rfm5 = rfm_fun(rfm, '2011-09-01', '2011-12-31', 6, 100000, '고정고객')
rfm5
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
      <th>gbn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>12347.0</td>
      <td>2011-12-07</td>
      <td>6</td>
      <td>391.62</td>
      <td>340 days</td>
      <td>2011-12</td>
      <td>06</td>
      <td>고정고객</td>
    </tr>
    <tr>
      <th>5</th>
      <td>12352.0</td>
      <td>2011-11-03</td>
      <td>7</td>
      <td>2211.10</td>
      <td>306 days</td>
      <td>2011-11</td>
      <td>07</td>
      <td>고정고객</td>
    </tr>
    <tr>
      <th>12</th>
      <td>12359.0</td>
      <td>2011-12-02</td>
      <td>6</td>
      <td>2225.11</td>
      <td>335 days</td>
      <td>2011-12</td>
      <td>06</td>
      <td>고정고객</td>
    </tr>
    <tr>
      <th>15</th>
      <td>12362.0</td>
      <td>2011-12-06</td>
      <td>13</td>
      <td>1083.29</td>
      <td>339 days</td>
      <td>2011-12</td>
      <td>10~</td>
      <td>고정고객</td>
    </tr>
    <tr>
      <th>30</th>
      <td>12381.0</td>
      <td>2011-12-05</td>
      <td>6</td>
      <td>417.04</td>
      <td>338 days</td>
      <td>2011-12</td>
      <td>06</td>
      <td>고정고객</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4210</th>
      <td>18236.0</td>
      <td>2011-11-10</td>
      <td>6</td>
      <td>164.80</td>
      <td>313 days</td>
      <td>2011-11</td>
      <td>06</td>
      <td>고정고객</td>
    </tr>
    <tr>
      <th>4214</th>
      <td>18241.0</td>
      <td>2011-11-30</td>
      <td>18</td>
      <td>342.14</td>
      <td>333 days</td>
      <td>2011-11</td>
      <td>10~</td>
      <td>고정고객</td>
    </tr>
    <tr>
      <th>4224</th>
      <td>18257.0</td>
      <td>2011-10-31</td>
      <td>10</td>
      <td>421.08</td>
      <td>303 days</td>
      <td>2011-10</td>
      <td>10</td>
      <td>고정고객</td>
    </tr>
    <tr>
      <th>4233</th>
      <td>18272.0</td>
      <td>2011-12-07</td>
      <td>7</td>
      <td>391.16</td>
      <td>340 days</td>
      <td>2011-12</td>
      <td>07</td>
      <td>고정고객</td>
    </tr>
    <tr>
      <th>4242</th>
      <td>18283.0</td>
      <td>2011-12-06</td>
      <td>14</td>
      <td>1220.93</td>
      <td>339 days</td>
      <td>2011-12</td>
      <td>10~</td>
      <td>고정고객</td>
    </tr>
  </tbody>
</table>
<p>855 rows × 8 columns</p>
</div>




```python
rfm6 = rfm_fun(rfm, '2011-04-01', '2011-08-31', 1, 3, '일반고객')
rfm6
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
      <th>gbn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6</th>
      <td>12353.0</td>
      <td>2011-05-19</td>
      <td>1</td>
      <td>24.30</td>
      <td>138 days</td>
      <td>2011-05</td>
      <td>01</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>7</th>
      <td>12354.0</td>
      <td>2011-04-21</td>
      <td>1</td>
      <td>261.22</td>
      <td>110 days</td>
      <td>2011-04</td>
      <td>01</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>8</th>
      <td>12355.0</td>
      <td>2011-05-09</td>
      <td>1</td>
      <td>54.65</td>
      <td>128 days</td>
      <td>2011-05</td>
      <td>01</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>16</th>
      <td>12363.0</td>
      <td>2011-08-22</td>
      <td>2</td>
      <td>53.17</td>
      <td>233 days</td>
      <td>2011-08</td>
      <td>02</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>27</th>
      <td>12378.0</td>
      <td>2011-08-02</td>
      <td>1</td>
      <td>656.44</td>
      <td>213 days</td>
      <td>2011-08</td>
      <td>01</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4195</th>
      <td>18220.0</td>
      <td>2011-05-04</td>
      <td>2</td>
      <td>4.62</td>
      <td>123 days</td>
      <td>2011-05</td>
      <td>02</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>4202</th>
      <td>18227.0</td>
      <td>2011-05-06</td>
      <td>1</td>
      <td>43.25</td>
      <td>125 days</td>
      <td>2011-05</td>
      <td>01</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>4228</th>
      <td>18262.0</td>
      <td>2011-07-22</td>
      <td>1</td>
      <td>14.60</td>
      <td>202 days</td>
      <td>2011-07</td>
      <td>01</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>4231</th>
      <td>18268.0</td>
      <td>2011-07-28</td>
      <td>1</td>
      <td>25.50</td>
      <td>208 days</td>
      <td>2011-07</td>
      <td>01</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>4240</th>
      <td>18281.0</td>
      <td>2011-06-12</td>
      <td>1</td>
      <td>39.36</td>
      <td>162 days</td>
      <td>2011-06</td>
      <td>01</td>
      <td>일반고객</td>
    </tr>
  </tbody>
</table>
<p>766 rows × 8 columns</p>
</div>




```python
rfm7 = rfm_fun(rfm, '2011-09-01', '2011-12-31', 2, 3, '일반고객')
rfm7
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
      <th>gbn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>12348.0</td>
      <td>2011-09-25</td>
      <td>3</td>
      <td>129.11</td>
      <td>267 days</td>
      <td>2011-09</td>
      <td>03</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>9</th>
      <td>12356.0</td>
      <td>2011-11-17</td>
      <td>3</td>
      <td>188.87</td>
      <td>320 days</td>
      <td>2011-11</td>
      <td>03</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>11</th>
      <td>12358.0</td>
      <td>2011-12-08</td>
      <td>2</td>
      <td>157.21</td>
      <td>341 days</td>
      <td>2011-12</td>
      <td>02</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>13</th>
      <td>12360.0</td>
      <td>2011-10-18</td>
      <td>3</td>
      <td>457.91</td>
      <td>290 days</td>
      <td>2011-10</td>
      <td>03</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>20</th>
      <td>12370.0</td>
      <td>2011-10-19</td>
      <td>2</td>
      <td>204.27</td>
      <td>291 days</td>
      <td>2011-10</td>
      <td>02</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4235</th>
      <td>18274.0</td>
      <td>2011-11-22</td>
      <td>2</td>
      <td>80.78</td>
      <td>325 days</td>
      <td>2011-11</td>
      <td>02</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>4236</th>
      <td>18276.0</td>
      <td>2011-11-18</td>
      <td>2</td>
      <td>47.25</td>
      <td>321 days</td>
      <td>2011-11</td>
      <td>02</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>4237</th>
      <td>18277.0</td>
      <td>2011-10-12</td>
      <td>2</td>
      <td>37.88</td>
      <td>284 days</td>
      <td>2011-10</td>
      <td>02</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>4241</th>
      <td>18282.0</td>
      <td>2011-12-02</td>
      <td>3</td>
      <td>62.68</td>
      <td>335 days</td>
      <td>2011-12</td>
      <td>03</td>
      <td>일반고객</td>
    </tr>
    <tr>
      <th>4243</th>
      <td>18287.0</td>
      <td>2011-10-28</td>
      <td>3</td>
      <td>104.55</td>
      <td>300 days</td>
      <td>2011-10</td>
      <td>03</td>
      <td>일반고객</td>
    </tr>
  </tbody>
</table>
<p>902 rows × 8 columns</p>
</div>




```python
finrfm = pd.concat([rfm0, rfm1, rfm2, rfm3, rfm4, rfm5, rfm6, rfm7], axis=0)
finrfm.sample()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>Month</th>
      <th>Freq_2</th>
      <th>gbn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1415</th>
      <td>14301.0</td>
      <td>2011-08-24</td>
      <td>2</td>
      <td>21.53</td>
      <td>235 days</td>
      <td>2011-08</td>
      <td>02</td>
      <td>일반고객</td>
    </tr>
  </tbody>
</table>
</div>



### RFM & Linear Regression

#### 데이터 전처리


```python
rd1.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CustomerID</th>
      <th>InvoiceDate</th>
      <th>Quantity</th>
      <th>UnitPrice</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>6</td>
      <td>2.55</td>
      <td>2010-12-01</td>
    </tr>
    <tr>
      <th>1</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>6</td>
      <td>3.39</td>
      <td>2010-12-01</td>
    </tr>
    <tr>
      <th>2</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>8</td>
      <td>2.75</td>
      <td>2010-12-01</td>
    </tr>
    <tr>
      <th>3</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>6</td>
      <td>3.39</td>
      <td>2010-12-01</td>
    </tr>
    <tr>
      <th>4</th>
      <td>17850.0</td>
      <td>2010-12-01</td>
      <td>6</td>
      <td>3.39</td>
      <td>2010-12-01</td>
    </tr>
  </tbody>
</table>
</div>




```python
rd2 = rd1.copy()
```


```python
# 날짜 기준으로 분할하기
rd2 = rd2[(rd2['Date'] >= '2011-01-01') & (rd2['Date'] <= '2011-06-30')]
```


```python
# group2 = rd2.groupby('CustomerID').agg({'Date' : 'max', 
#                                                                        'CustomerID' : 'size',
#                                                                         'UnitPrice' : 'sum'})
# group2.columns = ['Max_Date', 'Frequency', 'Monetary']
# group2 = group2.reset_index().copy()
# group2['Recency'] = group2['Max_Date'] - pd.to_datetime('2011-01-01')
# group2
```


```python
# RFM 함수 사용
def rfm_fun1(df, the_date):
    g = df.groupby('CustomerID').agg({'Date' : 'max', 
                                                               'CustomerID' : 'size',
                                                                'UnitPrice' : 'sum'})
    g.columns = ['Max_Date', 'Frequency', 'Monetary']
    g = g.reset_index().copy()
    g['Recency'] = g['Max_Date'] - pd.to_datetime(the_date)
    return g
```


```python
df1 = rfm_fun1(rd2, '2011-01-01')
df1.head(3)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CustomerID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12346.0</td>
      <td>2011-01-18</td>
      <td>2</td>
      <td>2.08</td>
      <td>17 days</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12347.0</td>
      <td>2011-06-09</td>
      <td>71</td>
      <td>189.08</td>
      <td>159 days</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12348.0</td>
      <td>2011-04-05</td>
      <td>11</td>
      <td>86.61</td>
      <td>94 days</td>
    </tr>
  </tbody>
</table>
</div>




```python
rd3 =  rd1[(rd1['Date'] >= '2011-07-01') & (rd1['Date'] <= '2011-12-31')].copy()
```


```python
# 예측할 값
np_ = rd3.groupby('CustomerID')['UnitPrice'].sum().reset_index()
np_ = np_.rename(columns={'UnitPrice' : 'NextPaying'})
np_.head(1)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CustomerID</th>
      <th>NextPaying</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12347.0</td>
      <td>202.54</td>
    </tr>
  </tbody>
</table>
</div>




```python
rfm_lm = pd.merge(left=df1, right=np, how='inner', on='CustomerID')
rfm_lm
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CustomerID</th>
      <th>Max_Date</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>Recency</th>
      <th>NextPaying</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12347.0</td>
      <td>2011-06-09</td>
      <td>71</td>
      <td>189.08</td>
      <td>159 days</td>
      <td>202.54</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12348.0</td>
      <td>2011-04-05</td>
      <td>11</td>
      <td>86.61</td>
      <td>94 days</td>
      <td>42.50</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12352.0</td>
      <td>2011-03-22</td>
      <td>48</td>
      <td>1900.07</td>
      <td>80 days</td>
      <td>311.03</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12356.0</td>
      <td>2011-04-08</td>
      <td>57</td>
      <td>165.17</td>
      <td>97 days</td>
      <td>23.70</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12359.0</td>
      <td>2011-06-03</td>
      <td>145</td>
      <td>1350.89</td>
      <td>153 days</td>
      <td>874.22</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1898</th>
      <td>18272.0</td>
      <td>2011-05-11</td>
      <td>59</td>
      <td>113.50</td>
      <td>130 days</td>
      <td>277.66</td>
    </tr>
    <tr>
      <th>1899</th>
      <td>18273.0</td>
      <td>2011-03-27</td>
      <td>1</td>
      <td>2.55</td>
      <td>85 days</td>
      <td>5.10</td>
    </tr>
    <tr>
      <th>1900</th>
      <td>18277.0</td>
      <td>2011-01-25</td>
      <td>1</td>
      <td>12.75</td>
      <td>24 days</td>
      <td>25.13</td>
    </tr>
    <tr>
      <th>1901</th>
      <td>18283.0</td>
      <td>2011-06-23</td>
      <td>343</td>
      <td>594.66</td>
      <td>173 days</td>
      <td>626.27</td>
    </tr>
    <tr>
      <th>1902</th>
      <td>18287.0</td>
      <td>2011-05-22</td>
      <td>29</td>
      <td>56.92</td>
      <td>141 days</td>
      <td>47.63</td>
    </tr>
  </tbody>
</table>
<p>1903 rows × 6 columns</p>
</div>




```python
rfm_lm.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 1903 entries, 0 to 1902
    Data columns (total 6 columns):
     #   Column      Non-Null Count  Dtype          
    ---  ------      --------------  -----          
     0   CustomerID  1903 non-null   float64        
     1   Max_Date    1903 non-null   datetime64[ns] 
     2   Frequency   1903 non-null   int64          
     3   Monetary    1903 non-null   float64        
     4   Recency     1903 non-null   timedelta64[ns]
     5   NextPaying  1903 non-null   float64        
    dtypes: datetime64[ns](1), float64(3), int64(1), timedelta64[ns](1)
    memory usage: 104.1 KB
    


```python
# 데이터 형변환
rfm_lm['Recency'] = rfm_lm['Recency'].map(lambda x : str(x)).str.replace(' days 00:00:00', '')
rfm_lm['Recency'] = rfm_lm['Recency'].map(lambda x : int(x))
rfm_lm['Recency']
```




    0       159
    1        94
    2        80
    3        97
    4       153
           ... 
    1898    130
    1899     85
    1900     24
    1901    173
    1902    141
    Name: Recency, Length: 1903, dtype: int64




```python
rfm_lm.columns
```




    Index(['CustomerID', 'Max_Date', 'Frequency', 'Monetary', 'Recency',
           'NextPaying'],
          dtype='object')



#### 모델 돌리기


```python
# 입력변수와 목표변수 지정
feature_names = ['Frequency', 'Monetary', 'Recency']
X = rfm_lm[feature_names]

label_name = 'NextPaying'
y = rfm_lm[label_name]
```


```python
# 데이터 분할
from sklearn.model_selection import train_test_split

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=42)
```


```python
print(X_train.shape)
y_train.shape
```

    (1332, 3)
    




    (1332,)




```python
from sklearn.linear_model import LinearRegression

lm = LinearRegression()
```


```python
# 모델 적합
lm.fit(X_train, y_train)
```




    LinearRegression(copy_X=True, fit_intercept=True, n_jobs=None, normalize=False)




```python
# 모델 예측
pred = lm.predict(X_test)
pred[:5]
```




    array([-28.98360613,  27.97172078,  67.85987049, -20.58813432,
            68.38982282])




```python
print(lm.intercept_, lm.coef_)
```

    121.66640554326881 [ 3.49238998  0.28475062 -1.34041994]
    

#### 모델 평가


```python
import statsmodels.api as sm

X = sm.add_constant(X)
results = sm.OLS(y, X).fit()
results.summary()
```




<table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>       <td>NextPaying</td>    <th>  R-squared:         </th> <td>   0.543</td> 
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th> <td>   0.542</td> 
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th> <td>   751.5</td> 
</tr>
<tr>
  <th>Date:</th>             <td>Wed, 06 May 2020</td> <th>  Prob (F-statistic):</th> <td>4.99e-322</td>
</tr>
<tr>
  <th>Time:</th>                 <td>04:40:02</td>     <th>  Log-Likelihood:    </th> <td> -14380.</td> 
</tr>
<tr>
  <th>No. Observations:</th>      <td>  1903</td>      <th>  AIC:               </th> <td>2.877e+04</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td>  1899</td>      <th>  BIC:               </th> <td>2.879e+04</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>     3</td>      <th>                     </th>     <td> </td>    
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>     <td> </td>    
</tr>
</table>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>const</th>     <td>   95.4094</td> <td>   33.371</td> <td>    2.859</td> <td> 0.004</td> <td>   29.963</td> <td>  160.856</td>
</tr>
<tr>
  <th>Frequency</th> <td>    3.0912</td> <td>    0.108</td> <td>   28.695</td> <td> 0.000</td> <td>    2.880</td> <td>    3.302</td>
</tr>
<tr>
  <th>Monetary</th>  <td>    0.2899</td> <td>    0.016</td> <td>   18.420</td> <td> 0.000</td> <td>    0.259</td> <td>    0.321</td>
</tr>
<tr>
  <th>Recency</th>   <td>   -0.9397</td> <td>    0.250</td> <td>   -3.764</td> <td> 0.000</td> <td>   -1.429</td> <td>   -0.450</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>2586.683</td> <th>  Durbin-Watson:     </th>  <td>   1.981</td>  
</tr>
<tr>
  <th>Prob(Omnibus):</th>  <td> 0.000</td>  <th>  Jarque-Bera (JB):  </th> <td>1920952.215</td>
</tr>
<tr>
  <th>Skew:</th>           <td> 7.071</td>  <th>  Prob(JB):          </th>  <td>    0.00</td>  
</tr>
<tr>
  <th>Kurtosis:</th>       <td>158.005</td> <th>  Cond. No.          </th>  <td>2.58e+03</td>  
</tr>
</table><br/><br/>Warnings:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.<br/>[2] The condition number is large, 2.58e+03. This might indicate that there are<br/>strong multicollinearity or other numerical problems.




```python
import matplotlib.pyplot as plt
plt.rc('font', family='Malgun Gothic')
import seaborn as sns
sns.set()

plt.figure(figsize=(15, 8))
sns.distplot(y_test - pred)
```




    <matplotlib.axes._subplots.AxesSubplot at 0x274501c99c8>




<img width="894" alt="output_84_1" src="https://user-images.githubusercontent.com/59638493/81112029-fc3d6f00-8f58-11ea-9b27-a0027b892640.png">



```python
# RMSE
import numpy as np
np.sqrt(np.square(y_test - pred).mean())
```




    414.58751835229873




```python
# MAPE
abs((y_test - pred) / y_test).mean() * 100
```




    245.57088945865084




```python
plt.figure(figsize=(15, 7))
sns.distplot(y_test, hist=False, label='실제값')
sns.distplot(pred, hist=False, label='예측값')
```




    <matplotlib.axes._subplots.AxesSubplot at 0x274500bccc8>




<img width="894" alt="output_87_1" src="https://user-images.githubusercontent.com/59638493/81112060-0a8b8b00-8f59-11ea-8612-81ef17d2db8a.png">



```python

```
